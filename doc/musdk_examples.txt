Running MUSDK Examples
======================

PKT-ECHO
--------

Functional Overview
~~~~~~~~~~~~~~~~~~~
The pkt-echo application performs all required initializations, using the MUSDK API's.

The application provides several compile-time options, as described below::

	#define PKT_ECHO_SUPPORT	(default=defined)
		  PKT_ECHO_SUPPORT will scrub the packet_header, by swapping L2 MAC addresses and IPV4 addresses.
		  Without it, pkt_echo application will not touch the packet at all.

	#define USE_APP_PREFETCH	(default=defined)
		  USE_APP_PREFETCH prefetches the pkt_buffer of a packet that is few packets behind
		  the currently_handled packet in the receive_queue.
		  This significantly improves performance for usecases where packets are being modified.

	#define PREFETCH_SHIFT	(7)
		  PREFETCH_SHIFT defines the number-of-packets-ahead in the receive_queue that is prefetched.

	#define HW_BUFF_RECYLC	(default=undefined)
		  This mode makes use of Hardware Buffer Recycling:
		  The buffer of the transmitted packet is returned to the Buffer Manager automatically by Hardware.
		  Example usecase is when the bpool of received packet and the transmitted packet is the same.

	#define SW_BUFF_RECYLCE	(default=undefined)
		  Mechanism demonstrating use of index_based cookies instead virtual_addresses for buffer_pointers.

	#define HW_TX_CHKSUM_CALC	(default=undefined)
		  This causes packet_send to request Hardware to perform L3/L4 checksum calculation.

How To Run
~~~~~~~~~~
    Base Configuration for A8040-DB::

		> ifconfig eth0 10.10.10.1 netmask 255.255.255.0 up
		> ifconfig eth1 11.11.11.1 netmask 255.255.255.0 up
		> ifconfig eth2 12.12.12.1 netmask 255.255.255.0 up
		> ifconfig eth3 13.13.13.1 netmask 255.255.255.0 up
		> sleep 1
		> insmod musdk_uio.ko
		> insmod mv_pp_uio.ko
		> insmod mvpp2x_sysfs.ko

    Command parameters:

	See help in application.

    Limitations
	- It is assumed the interface is brought up in Linux before being used by musdk_pkt_echo.


    1. Examples for single core, no RSS::

	a. 10G eth0 queue 0, cpu_core 3

		> ./musdk_pkt_echo -i eth0 -a 3

	b. 10G eth2, queue 0, cpu_core 3

		> ./musdk_pkt_echo -i eth2 -a 3

	c. 10G eth0 <-> eth2, queue 0, cpu_core 3

		> ./musdk_pkt_echo -i eth0,eth2 -a 3

	d. 1G eth3, queue 0, cpu_core 3

		> ./musdk_pkt_echo -i eth3 -a 3


    2. Examples for two cores, with RSS::

	a. 10G eth0, queue 0,1, core 1,2

		> ./musdk_pkt_echo -i eth0 -c 2 -m 1:1 -a 1

	b. 10G eth2, queue 0,1, core 1,2

		> ./musdk_pkt_echo -i eth2 -c 2 -m 1:1 -a 1

	c. 10G eth0 <-> eth2, queue 0,1 core 1,2

		> ./musdk_pkt_echo -i eth0,eth2 -c 2 -m 1:1 -a 1


PKT_L3FWD
---------
The musdk_pkt_l3fwd is a basic L3 forwarding application supplied with MUSDK framework, and is based on destination
IP forwarding (LPM). Marvell L3 FWD application is extended to support full Layer3 - 5-tuple forwarding. Original destination
IP forwarding is supported as well.
User can choose between the L3 forwarding application types by using the next flag located in l3fwd_db.h file:

		#define LPM_FRWD

In order to enable the 5-tuple forwarding the application should be recompiled without the above #define.

Basic Configuration
~~~~~~~~~~~~~~~~~~~

A default configuration option is supplied by MUSDK framework through command line.
The L3 Forwarding applet is invoked by calling: musdk_pkt_l3fwd.

Mandatory OPTIONS::

		-i, --interface eth interfaces (comma-separated, no spaces)

For LPM forwarding::
		-r, --route SubNet,Intf[,NextHopMAC] NextHopMAC can be optional

For 5-tuple forwarding::
		-r, --route Src_SubNet,Dst_SubNet,Src_Port,Dst_Port,0-UDP/1-TCP,Dst_Intf[,NextHopMAC] NextHopMAC can be optional

Optional OPTIONS::

		-b <size>                Burst size, num_pkts handled in a batch.(default is 1024)
		--mtu <mtu>              Set MTU (default is 1500)
		-c, --cores <number>     Number of CPUs to use
		-a, --affinity <number>  Use setaffinity (default is no affinity)
		-s                       Maintain statistics
		-w <cycles>              Cycles to busy_wait between recv&send, simulating app behavior (default=0)
		--rxq <size>             Size of rx_queue (default is 2048)
		--cli                    Use CLI
		--routing-file           Use *.xml file
		--mac-dst-file           Use *.xml file
		?, -h, --help            Display help and exit.

Example for LPM forwarding::

		> ./musdk_pkt_l3fwd -i eth1,eth3 -r 192.168.1.0/24,eth3 -r 1.1.1.0/24,eth1

The above command will initialize eth1 and eth3 ports. in addition, all traffic with subnet 192.168.1.0/24 will
forward to eth3, and all traffic with subnet  r 1.1.1.0/24 will forward to eth1, other traffic will be dropped.

Example for 5-tuple forwarding::

		> musdk_pkt_l3fwd -i eth0,eth2 -r 1.1.1.10/24,192.168.1.10/24,1024,1024,0,eth0

The above command line will initialize eth0 and eth2 ports. in addition,  all traffic with 5 tuple: src ip: 1.1.1.10,
dst ip: 192.168.10, src port: 1024, dst port: 1024 and UDP,  will forward to eth0, other traffic will be dropped.


XML files
~~~~~~~~~
Marvell applet support optional configuration using xml files. When there are valid XML files the applet will take the
configuration first from command line and the rest configuration from XML file up to 64K entries.
The XML filename and path may be passed to the applet through command line (see --routing-file and
--mac-dst-file options above).

The following xml files supported:

	- Forwarding table for L3 FWD application based on LPM forwarding. Example: l3_routing_lpm.xml::

			<?xml version="1.0"?>
			<L3Route>
			  <RouteEntry>
				<Lpm>
					<Subnet>192.168.1.0/24</Subnet>
				</Lpm>
			  <OutIf>eth0</OutIf>
			  </RouteEntry>
			  <RouteEntry>
				<Lpm>
					<Subnet> 1.1.1.0/24</Subnet>
				</Lpm>
			  <OutIf>eth0</OutIf>
			  </RouteEntry>
			</L3Route>

	- Forwarding table for L3 FWD application based on 5-tuple forwarding. Example: l3_routing_hash.xml::

			<?xml version="1.0"?>
			<L3Route>
			  <RouteEntry>
				<Tuple>
					<SrcIP>1.1.1.10</SrcIP>
					<DstIP>192.168.1.10</DstIP>
					<SrcPort>1024</SrcPort>
					<DstPort>1024</DstPort>
					<Protocol>UDP</Protocol>
				</Tuple>
				<OutIf>eth1</OutIf>
			   </RouteEntry>
			  <RouteEntry>
				<Tuple>
					<SrcIP>192.168.1.10</SrcIP>
					<DstIP>1.1.1.10</DstIP>
					<SrcPort>1024</SrcPort>
					<DstPort>1024</DstPort>
					<Protocol>UDP</Protocol>
				</Tuple>
				<OutIf>eth3</OutIf>
			   </RouteEntry>
			</L3Route>

	- Next hop table containing a list of destination mac address. Example: if_to_mac.xml::

			<?xml version="1.0"?>
			<IF_MAC>
			  <Nexthop>
			    <If>eth0</If>
				<Mac>00:00:00:22:22:00</Mac>
			  </Nexthop>
			  <Nexthop>
			    <If>eth1</If>
				<Mac>00:00:00:22:22:01</Mac>
			  </Nexthop>
			  <Nexthop>
			    <If>eth2</If>
				<Mac>00:00:00:22:22:02</Mac>
			  </Nexthop>
			  <Nexthop>
			    <If>eth3</If>
				<Mac>00:00:00:22:22:03</Mac>
			  </Nexthop>
			</IF_MAC>


CLS-DEMO
----------

Functional Overview
~~~~~~~~~~~~~~~~~~~~
The 'musdk_cls_demo' example application allows configuring several classifier related features as follows:
		- classification rules
		- logical port parameters
		- QoS
		- MAC address filtering
		- VLAN filtering
		- RSS

The application performs all required initializations, using the MUSDK API's.
It includes an "echo" mode allowing to loopback traffic sent to the specific port.


How To Run
~~~~~~~~~~
(1) Preferrably use a A8040-A1-DB or A7040-A0-DB board.

(2) Compile code as written in the "Getting Started" section:
	- Skip SAM compilation phase.
	- Make sure ALL patches are applied.

(3) In Linux, bring up the required interfaces

(4) Bring up the modules. Below output is for a A8040-DB::

		> cd /
		> insmod musdk_uio.ko
		Registered cma device: uio-cma
		> insmod mv_pp_uio.ko
		Registered 2 uio devices, having 6 register maps attached
		Registered 2 uio devices, having 6 register maps attached

    In case MAC filtering is used for configuring unicast address, or RSS is used, the following is also needed::

		> insmod mvpp2x_sysfs.ko

(5) Run the musdk_cls_demo application::

		> ./musdk_cls_demo -i <eth>

    Parameters::

	- '-i eth0' is the linux interface name.
	- '--echo' - sets the cls_demo application in echo mode, enabling loopback of received traffic over the
	  same openned port
	- '--logical_port_params' when the interface is a logical port, this parameter needs to be present,
	  in which case the application requires to configure the logical port parameters (see 2 below)
	- '--ppio_tag_mode' when a special tag mode is to be used as filtering for the logical port
	- '--hash_type' sets the hash type to be used for RSS according to the following values:
		- none:		hash is disabled
		- 2-tuple:	hash is calculated using IP source address and IP destination address (IPv4 and IPv6)
		- 5-tuple:	hash is calculated using IP source address, IP destination address, IP protocol(TCP/UDP only),
				L4 source port, L4 destination port (IPv4 and IPv6)

  Examples:

  (a) For MUSDK port::

		> ./musdk_cls_demo -i <eth> --echo

  (b) For logical port::

		> ./musdk_cls_demo -i ppio-0:0 --echo --logical_port_params

	When the --logical_port_params is provided, the application prompts the user
	to enter the relevant logical_port classifier parameters as follows::

		please enter logical port params:
			* --target                (dec)
			* --num_proto_rule_sets   (dec)
			* --num_rules             (dec)
			* --rule_type             (dec)
			* --proto                 (dec)
			* --proto_val             (dec)
			* --special_proto         (dec)
			* --special_fields        (dec)
			* --field_val             (dec)

	where::

			--target:		Indicate whether the network protocol rules defined will be used for
						the logical-port (target = 0) or for the NIC (target = 1)
						NOTE: In current release only target = 0 is supported
			--num_proto_rule_sets: 	Number of protocol rule sets to be defined
						NOTE: In current release only num_proto_rule_sets = 1 is supported
			--num_rules:		Number of rules defined for each protocol set
			--rule_type:     	Defines if the rule is a protocol rule or a special field in a protocol
						rule_type = 0 (protocol rule), rule_type = 1 (protocol field rule)
			--proto         	Defines the protocol to match
						NOTE: In current release only UDP or TCP protocols are supported
						(values according to mv_net.h file)
						proto = 9 (TCP), proto = 10 (UDP)
			--proto_val             Indicates whether the selected network protocol is to be matched
						or the negated network protocol is to be matched
						i.e. if VLAN protocol is specified:
						val = 0 indicates all tagged frames are to be matched
						val = 1 indicates all untagged frames are to be matched
						NOTE: In current release protocol_val = 0 is supported
			--special_proto 	Defines a network special protocol to be supported by logical port
						NOTE: in current release, the following special protocols are supported:
						special_proto = 2 (DSA tag)
			--special_fields        NOTE: in current release, the following special protocols fields are supported:
						special_field = 0 (DSA tag mode)
			--field_val             Defines the value of the specified special protocol field
						the available values are defined in mv_net.h under mv_net_eth_dsa_tag_mode_values:
						i.e. field_val = 3 for DSA tag mode forward

	Example configurations for logical port:

	logical port + tcp filter::

			> musdk_cls_demo -i eth1 --echo --logical_port_params
			  --target 0 --num_proto_rule_sets 1 --num_rules 1 --rule_type 0
			  --proto 9 --proto_val 0

	logical port + tcp&udp filter::

			> musdk_cls_demo -i eth1 --echo --logical_port_params
			  --target 0 --num_proto_rule_sets 1 --num_rules 2
			  --rule_type 0 --proto 9 --proto_val 0
			  --rule_type 0 --proto 10 --proto_val 0

  (c) For logical port with special tag filtering::

			> musdk_cls_demo -i eth1 --echo --logical_port_params --ppio_tag_mode

			please enter tag_mode:
				* --none 		no tag
				* --dsa			dsa tag
				* --extended_dsa	extended dsa tag

	Example configuration for logical port with DSA tag mode filtering::

			> musdk_cls_demo -i eth1 --echo --logical_port_params --ppio_tag_mode
			  --dsa
			  --target 0 --num_proto_rule_sets 1 --num_rules 4
			  --rule_type 1 --special_proto 2 --special_fields 0 --field_val 3

(6) Once the application is invoked, it will enter cli mode, where different commands may be issued.

   The following CLI commands are supported::

	+-----------------------+---------------------------------------------------------------------------------------+
	| Command		| Description									       	|
	+=======================+=======================================================================================+
	| help          	| print command description/usage							|
	+-----------------------+---------------------------------------------------------------------------------------+
	| ?          	     	| Alias for help									|
	+-----------------------+---------------------------------------------------------------------------------------+
	| cls_tbl_init		| create a classifier table according to key and default action:                        |
	|                       |                                                                                       |
	|			|	``cls_tbl_init --engine_type --tc --drop --key``				|
	|			|											|
	|			| --engine_type  (string) exact_match, maskable						|
	|                       |                                                                                       |
	|			| --tc           (dec) 1..8 - number of traffic classes					|
	|                       |                                                                                       |
	|			|	| By default only 1 is supported, unless kernel					|
	|			|	| is configured to support more than one queue.					|
	|			|	| Please refer to the section: 							|
	|			|	| "PPv2.2 Kernel Module Parameters" 						|
	|                       |                                                                                       |
	|			| --drop         (no argument) optional							|
	|                       |                                                                                       |
	|			| --key          (string) the following are currently supported:      			|
	|			|											|
	|			|	| ip4_src   - ipv4, souce address						|
	|			|	| ip4_dst   - ipv4, destination address						|
	|			|	| ip4_proto - ipv4, proto							|
	|			|	| l4_src    - layer4, source port						|
	|			|	| l4_dst    - layer4, destination port			        		|
	+-----------------------+---------------------------------------------------------------------------------------+
	| cls_rule_key_add      | add a classifier rule key to existing table:						|
	|                       |                                                                                       |
	|			|	``cls_rule_key_add --table_index --tc --drop --size --key --mask``		|
	|			|											|
	|			| --table_index   (dec) index to existing table						|
	|                       |                                                                                       |
	|			| --tc            (dec) 1..8								|
	|                       |                                                                                       |
	|			| --drop          (no argument) optional						|
	|                       |                                                                                       |
	|			| --size          (dec) size in bytes of the key					|
	|                       |                                                                                       |
	|			| --key           (dec or hex) key, for example:					|
	|                       |                                                                                       |
	|			| 		   	| ipv4: 192.168.10.5						|
	|			| 		   	| ipv6: 2605:2700:0:3::4713:93e3				|
	|			| 		   	| port: 0x1234							|
	|			| 		   	| udp: 17(IPPROTO_UDP)						|
	|			| 		   	| tcp: 6(IPPROTO_TCP)						|
	|                       |                                                                                       |
	|			| --mask          (hex) mask for the key (if maskable is used)				|
	+-----------------------+---------------------------------------------------------------------------------------+
	| mac_addr		| set/get/add/remove/flush ppio MAC address:						|
	|                       |                                                                                       |
	|			|	``mac_addr --set <xx:xx:xx:xx:xx:xx>``						|
	|                       |                                                                                       |
	|			|	``mac_addr --get``								|
	|                       |                                                                                       |
	|			|	``mac_addr --add <xx:xx:xx:xx:xx:xx>``						|
	|                       |                                                                                       |
	|			|	``mac_addr --remove <xx:xx:xx:xx:xx:xx>``					|
	|                       |                                                                                       |
	|			|	``mac_addr --flush --uc --mc``							|
	+-----------------------+---------------------------------------------------------------------------------------+
	| promisc  	       	| set/get ppio unicast/multicast promiscuous mode:					|
	|                       |                                                                                       |
	|			| 	``promisc --<uc/mc> --<on/off/get>``						|
	+-----------------------+---------------------------------------------------------------------------------------+
	| vlan          	| set/remove/flush ppio vlan filter:							|
	|                       |                                                                                       |
	|			| 	``vlan --set <vlan_id>``							|
	|                       |                                                                                       |
	|			|	``vlan --remove <vlan_id>``							|
	|                       |                                                                                       |
	|			|	``vlan --flush``								|
	+-----------------------+---------------------------------------------------------------------------------------+
	| cls_table_dump	| display classifier defined tables							|
	+-----------------------+---------------------------------------------------------------------------------------+
	| cls_rule_key_dump	| display classifier defined rule_keys							|
	+-----------------------+---------------------------------------------------------------------------------------+
	| cls_fl_log_rls_dump   | dump all logical flow ID and rule offset						|
	+-----------------------+---------------------------------------------------------------------------------------+
	| cls_lkp_hits_dump     | dump all hit decode entry and its DB information					|
	+-----------------------+---------------------------------------------------------------------------------------+
	| cls_fl_hits_dump      | dump all hit flow table entry								|
	+-----------------------+---------------------------------------------------------------------------------------+
	| cls_fl_rls_dump       | dump all logical flow ID rules							|
	+-----------------------+---------------------------------------------------------------------------------------+
	| cls_c3_rule_hit_dump  | dump C3 entries according to type and index:						|
	|                       |                                                                                       |
	|			| 	``cls_c3_rule_hit_dump --type --var`` 						|
	|			|											|
	|			| --type  (dec) C3 dump type, 0: logic idx, 1:hash idx, 2:lookup type			|
	|                       |                                                                                       |
	|			| --var   (dec) value according to type:						|
	|			|											|
	|			|		- type 0/1: idx								|
	|			|		- type 2: lookup type							|
	|			| 		- no arguments: dumping all flows					|
	+-----------------------+---------------------------------------------------------------------------------------+


CRYPTO-ECHO
------------

The crypto-echo application does the following operations:
	- receives packets from the network interface
	- encrypts the received packet (optional)
	- IPSec ESP encapsulation (tunnel or transport modes) only for A8040/A7040 (optional)
	- decrypts the packet (optional)
	- IPSec ESP decapsulation (tunnel or transport modes) only for A8040/A7040 (optional)
	- switches source and destination mac and ip addresses (optional).
	- sends the packet to the network interface

Application usage (A8040, A7040)::

	> musdk_pp2_crypto_echo OPTIONS

Application usage (A3700)::

	> musdk_neta_crypto_echo OPTIONS

Mandatory OPTIONS::

        -i, --interface <Eth-interfaces> (comma-separated, no spaces)
                  Interface count min 1, max 2
                  e.g. -i eth1,eth3

The interfaces must be brought up using "ifconfig <ifname> up" before running the application

Optional OPTIONS::

        -b             <size>    Burst size in bytes (default is 64)
        -c, --cores    <number>  Number of CPUs to use.
        -a, --affinity <number>  Use setaffinity (default is no affinity)
        -t             <mtu>     Set MTU in bytes (default is 1500)
        -v                       Increase verbose debug (default is 0)
                                 With every '-v', the debug is increased by one.
                                 0 - none, 1 - pkts sent/recv indication, 2 - full pkt dump
        --crypto-proto <proto>   Crypto protocol. Supports: [none, esp]. (default: none)
                                 Not supported for A3700.
        --tunnel                 IPSec tunnel mode. (default: transport)
                                 Valid only with "--crypto-proto esp"
        --ip6                    ESP over IPv6. (default: ESP over IPv4)
                                 Valid only with "--crypto-proto esp"
        --cipher-alg   <alg>     Cipher algorithm. Supports: [none, aes128, 3des]. (default: aes128)
        --cipher-mode  <alg>     Cipher mode. Support: [cbc, ecb]. (default: cbc)
        --auth-alg     <alg>     Authentication algorithm. Supports: [none, sha1]. (default: sha1)
        --dir          <dir>     Operation direction. Supports: [enc, dec, lb]. (default: lb)
        --no-echo                No swap of MAC and L3 addresses
        --cli                    Use CLI
        ?, -h, --help            Display help and exit.

Two CIO are created, one for encryption and other for decryption; if possible CIOs are taken from different engines.

For example:
   - in case of A8040 - encryption is done on cio-0:0, and decryption on cio-1:0
   - in case of A7040 or A3700 - encryption is done on cio-0:0, and decryption on cio-0:1

- If "--dir enc" - ingress packet will be only encrypted and will be sent out encrypted
- If "--dir dec" - ingress packet will be only decrypted and will be sent out decrypted
- If "--dir lb"  - ingress packet will be encrypted and then decrypted, so egress packet
		   must be the same as ingress.

- IPv6 mode is not supported, so --ip6 argument should not be set

In order to test crypto performance using musdk_crypo_echo, user should inject packets (udp or tcp),
into the MUSDK interface selected for the application.
